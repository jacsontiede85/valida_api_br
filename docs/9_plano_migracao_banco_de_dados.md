# üèóÔ∏è Plano de Migra√ß√£o de Banco de Dados - Supabase PostgreSQL ‚Üí MariaDB Local

## üéØ Vis√£o Geral da Migra√ß√£o

**Situa√ß√£o Atual**: Supabase PostgreSQL (Cloud)  
**Situa√ß√£o Desejada**: MariaDB Local (Self-hosted)  
**Complexidade**: **ALTA** - Sistema SaaS completo com 12+ tabelas e funcionalidades avan√ßadas  
**Tempo Estimado**: 2-3 dias de desenvolvimento + 1 dia de testes  

---

## üìä An√°lise Detalhada do Sistema Atual

### üóÇÔ∏è **Estrutura do Banco de Dados Atual (Supabase PostgreSQL)**

| Tabela | Registros | Prop√≥sito | Complexidade Migra√ß√£o |
|--------|-----------|-----------|----------------------|
| `users` | 7 | Gest√£o de usu√°rios do sistema | üü° **M√âDIA** - Adicionar campos Stripe |
| `subscription_plans` | 3 | Planos de assinatura dispon√≠veis | üü¢ **BAIXA** - Estrutura simples |
| `subscriptions` | 2 | Assinaturas ativas dos usu√°rios | üü° **M√âDIA** - Integra√ß√£o Stripe |
| `api_keys` | 10 | Chaves de API dos usu√°rios | üü¢ **BAIXA** - Hash SHA256 simples |
| `user_credits` | 2 | Sistema de cr√©ditos por usu√°rio | üü° **M√âDIA** - L√≥gica de neg√≥cio |
| `consultation_types` | 6 | Tipos de consulta com custos | üü¢ **BAIXA** - Dados de configura√ß√£o |
| `consultations` | 1 | Hist√≥rico de consultas realizadas | üü° **M√âDIA** - Volume de dados |
| `consultation_details` | 1 | Detalhes por tipo de cada consulta | üü° **M√âDIA** - Relacionamentos |
| `credit_transactions` | 2 | Transa√ß√µes de cr√©dito | üî¥ **ALTA** - Triggers complexos |
| `daily_analytics` | 1 | Analytics di√°rio consolidado | üü° **M√âDIA** - Agrega√ß√µes |
| `service_costs` | ‚ùì | Custos dos servi√ßos | üü¢ **BAIXA** - Tabela nova |
| `stripe_webhook_logs` | ‚ùì | Logs de webhooks Stripe | üü¢ **BAIXA** - Logs simples |

### üß© **Funcionalidades Espec√≠ficas do PostgreSQL/Supabase**

#### ‚ö†Ô∏è **Recursos Cr√≠ticos que Precisam de Adapta√ß√£o:**

1. **UUID com gen_random_uuid()** ‚Üí Substituir por CHAR(36) + UUID() do MariaDB
2. **TIMESTAMP WITH TIME ZONE** ‚Üí Substituir por DATETIME + controle de timezone na aplica√ß√£o  
3. **JSONB** ‚Üí Substituir por JSON do MariaDB
4. **Row Level Security (RLS)** ‚Üí Implementar controle de acesso na aplica√ß√£o
5. **PL/pgSQL Functions/Triggers** ‚Üí Reescrever em MySQL/MariaDB syntax
6. **Cliente Supabase Python** ‚Üí Migrar para PyMySQL ou mysql-connector-python

#### üîß **Views e Objetos Complexos:**

```sql
-- Views atuais que precisam ser adaptadas:
- user_credits_summary
- active_subscriptions  
- Agrega√ß√µes de analytics
```

#### ‚ö° **Triggers/Functions Cr√≠ticas:**

```sql
-- Fun√ß√£o principal que precisa ser reescrita:
update_user_credits() - Calcula saldo ap√≥s transa√ß√µes
trigger_update_user_credits - Trigger BEFORE INSERT
```

---

## üéØ Estrat√©gia de Migra√ß√£o

### **Fase 1: An√°lise e Prepara√ß√£o** ‚è±Ô∏è **4-6 horas**

#### 1.1 **Mapeamento Completo das Depend√™ncias**
- ‚úÖ **Conclu√≠do** - An√°lise detalhada realizada
- ‚úÖ **Conclu√≠do** - Identificadas todas as tabelas e relacionamentos  
- ‚úÖ **Conclu√≠do** - Mapeados servi√ßos que interagem com BD

#### 1.2 **Identifica√ß√£o de Incompatibilidades**
- **UUIDs**: PostgreSQL gen_random_uuid() ‚Üí MariaDB UUID()
- **Timezones**: TIMESTAMP WITH TIME ZONE ‚Üí DATETIME + pytz na aplica√ß√£o
- **JSON**: JSONB ‚Üí JSON (sintaxe ligeiramente diferente)
- **Triggers**: PL/pgSQL ‚Üí MySQL syntax
- **RLS**: Remover e implementar na aplica√ß√£o

---

### **Fase 2: Cria√ß√£o do Schema MariaDB** ‚è±Ô∏è **8-10 horas**

#### 2.1 **Cria√ß√£o do Arquivo bd.sql**
- Adaptar todas as 12+ tabelas para MariaDB syntax
- Converter UUIDs para CHAR(36) com triggers de gera√ß√£o
- Adaptar tipos de dados (TIMESTAMP, JSON, etc.)
- Reescrever constraints e foreign keys
- Criar √≠ndices otimizados

#### 2.2 **Triggers e Stored Procedures**
```sql
-- Exemplo de trigger a ser criado:
DELIMITER $$
CREATE TRIGGER trigger_update_user_credits
BEFORE INSERT ON credit_transactions
FOR EACH ROW
BEGIN
    -- L√≥gica do c√°lculo de saldo em MySQL syntax
END$$
DELIMITER ;
```

#### 2.3 **Views e Agrega√ß√µes**
- Recriar user_credits_summary adaptada para MariaDB
- Adaptar views de analytics
- Otimizar consultas para MySQL engine

---

### **Fase 3: Adapta√ß√£o do C√≥digo Python** ‚è±Ô∏è **6-8 horas**

#### 3.1 **Substitui√ß√£o do Cliente Supabase**
```python
# ANTES (Supabase):
from supabase import create_client
supabase = create_client(url, key)
result = supabase.table("users").select("*").execute()

# DEPOIS (MariaDB):
import pymysql
connection = pymysql.connect(host, user, password, database)
cursor = connection.cursor(pymysql.cursors.DictCursor)
cursor.execute("SELECT * FROM users")
result = cursor.fetchall()
```

#### 3.2 **Arquivos a serem Modificados**:
- `api/database/connection.py` - **CR√çTICO** - Cliente de conex√£o
- `api/database/models.py` - Adaptar tipos de dados (UUID ‚Üí str)
- `api/services/*.py` - Todos os 10+ servi√ßos que fazem queries
- `api/middleware/auth_middleware.py` - Autentica√ß√£o e queries de usu√°rio

#### 3.3 **Padr√µes de Migra√ß√£o por Servi√ßo**:

**CreditService** (Mais Cr√≠tico):
```python
# ANTES:
response = self.supabase.table("credit_transactions").insert(data).execute()

# DEPOIS:  
cursor.execute("""
    INSERT INTO credit_transactions (id, user_id, type, amount_cents, description) 
    VALUES (UUID(), %s, %s, %s, %s)
""", (user_id, type, amount_cents, description))
```

**DashboardService**, **HistoryService**, etc.:
- Adaptar todas as queries SELECT complexas
- Manter mesma l√≥gica de neg√≥cio
- Ajustar sintaxe de agrega√ß√µes e JOINs

---

### **Fase 4: Configura√ß√£o do Ambiente** ‚è±Ô∏è **2-3 horas**

#### 4.1 **Instala√ß√£o MariaDB Local**
```bash
# Ubuntu/Debian:
sudo apt update
sudo apt install mariadb-server mariadb-client

# Windows (via Docker):
docker run -d --name mariadb \
  -e MYSQL_ROOT_PASSWORD=senha_segura \
  -e MYSQL_DATABASE=valida_saas \
  -e MYSQL_USER=valida_user \  
  -e MYSQL_PASSWORD=senha_user \
  -p 3306:3306 \
  mariadb:latest
```

#### 4.2 **Configura√ß√£o de Seguran√ßa**
```sql
-- Criar usu√°rio espec√≠fico para a aplica√ß√£o
CREATE USER 'valida_saas'@'localhost' IDENTIFIED BY 'senha_super_segura';
GRANT ALL PRIVILEGES ON valida_saas.* TO 'valida_saas'@'localhost';
FLUSH PRIVILEGES;
```

#### 4.3 **Vari√°veis de Ambiente (.env)**
```env
# ANTES (Supabase):
SUPABASE_URL=https://xxx.supabase.co
SUPABASE_SERVICE_ROLE_KEY=xxx

# DEPOIS (MariaDB):
DB_HOST=localhost
DB_PORT=3306
DB_NAME=valida_saas  
DB_USER=valida_saas
DB_PASSWORD=senha_super_segura
DB_CHARSET=utf8mb4
```

---

### **Fase 5: Migra√ß√£o de Dados** ‚è±Ô∏è **4-6 horas**

#### 5.1 **Exporta√ß√£o dos Dados do Supabase**
```python
# Script de exporta√ß√£o a ser criado:
export_supabase_data.py
- Conectar no Supabase
- Exportar todas as tabelas para JSON/CSV
- Manter relacionamentos e refer√™ncias
```

#### 5.2 **Importa√ß√£o para MariaDB**
```python
# Script de importa√ß√£o a ser criado:  
import_to_mariadb.py
- Converter UUIDs para formato MariaDB
- Ajustar timestamps para UTC
- Manter integridade referencial
```

#### 5.3 **Dados Cr√≠ticos a Migrar**:
| Tabela | Volume | Criticalidade | Observa√ß√µes |
|--------|--------|---------------|-------------|
| users | 7 registros | üî¥ **CR√çTICA** | Senhas, emails, dados pessoais |
| api_keys | 10 registros | üî¥ **CR√çTICA** | Chaves ativas, hashs SHA256 |
| subscriptions | 2 registros | üü° **ALTA** | Planos ativos, Stripe IDs |
| credit_transactions | 2 registros | üü° **ALTA** | Hist√≥rico financeiro |
| consultations | 1+ registros | üü° **M√âDIA** | Hist√≥rico de uso |

---

### **Fase 6: Testes e Valida√ß√£o** ‚è±Ô∏è **8-10 horas**

#### 6.1 **Testes Unit√°rios**
- Testar cada servi√ßo individualmente
- Validar queries e resultados
- Verificar performance vs Supabase

#### 6.2 **Testes de Integra√ß√£o**
- Fluxo completo de autentica√ß√£o  
- Consultas CNPJ end-to-end
- Sistema de cr√©ditos e cobran√ßa
- Dashboard e analytics

#### 6.3 **Testes de Carga**
- Stress test com m√∫ltiplas consultas simult√¢neas
- Validar triggers de cr√©dito sob press√£o
- Monitorar locks e deadlocks

#### 6.4 **Valida√ß√£o de Dados**
```python
# Script de valida√ß√£o a ser criado:
validate_migration.py
- Comparar contagens de registros
- Verificar integridade de relacionamentos  
- Validar c√°lculos de cr√©ditos
- Testar todas as funcionalidades cr√≠ticas
```

---

## üìÅ Arquivos a Serem Criados/Modificados

### **üÜï Arquivos Novos** 
1. `bd.sql` - Schema completo MariaDB ‚≠ê **PRINCIPAL ENTREG√ÅVEL**
2. `scripts/export_supabase_data.py` - Exporta√ß√£o de dados
3. `scripts/import_to_mariadb.py` - Importa√ß√£o de dados  
4. `scripts/validate_migration.py` - Valida√ß√£o p√≥s-migra√ß√£o
5. `docker-compose.mariadb.yml` - Setup local via Docker

### **üîß Arquivos a Modificar**
1. `requirements.txt` - Adicionar PyMySQL/mysql-connector-python
2. `api/database/connection.py` - **CR√çTICO** - Nova l√≥gica de conex√£o
3. `api/database/models.py` - Adaptar tipos UUID ‚Üí str
4. `api/services/*.py` - **10+ arquivos** - Adaptar queries
5. `api/middleware/auth_middleware.py` - Adaptar autentica√ß√£o  
6. `.env.example` - Novas vari√°veis de BD

---

## ‚ö° Riscos e Mitiga√ß√µes

### üî¥ **Riscos ALTOS**

| Risco | Probabilidade | Impacto | Mitiga√ß√£o |
|-------|---------------|---------|-----------|
| **Perda de dados durante migra√ß√£o** | M√©dia | Cr√≠tico | Backup completo + valida√ß√£o rigorosa |
| **Triggers complexos com bugs** | Alta | Alto | Testes extensivos + rollback plan |
| **Performance degradada** | M√©dia | Alto | √çndices otimizados + monitoramento |
| **Incompatibilidade de queries** | Alta | M√©dio | Testes unit√°rios completos |

### üü° **Riscos M√âDIOS**

- **Timezone issues** ‚Üí Usar UTC + convers√µes na aplica√ß√£o
- **JSON syntax differences** ‚Üí Testes espec√≠ficos para campos JSON  
- **Connection pooling** ‚Üí Implementar pool adequado para MariaDB

---

## üìã Cronograma Detalhado

### **Semana 1 - Prepara√ß√£o e Schema**
- **Dia 1-2**: Cria√ß√£o bd.sql + adapta√ß√£o de triggers
- **Dia 3**: Modifica√ß√£o connection.py + models.py
- **Dia 4**: Adapta√ß√£o dos services principais (credit, user, auth)
- **Dia 5**: Adapta√ß√£o servi√ßos restantes + dashboard

### **Semana 2 - Migra√ß√£o e Testes**  
- **Dia 1**: Scripts de export/import + migra√ß√£o de dados
- **Dia 2-3**: Testes unit√°rios + integra√ß√£o + corre√ß√£o de bugs
- **Dia 4**: Testes de carga + otimiza√ß√£o performance
- **Dia 5**: Deploy e monitoramento + documenta√ß√£o

---

## ‚úÖ Crit√©rios de Sucesso

### **Funcionais:**
- ‚úÖ Todos os endpoints da API funcionando  
- ‚úÖ Sistema de autentica√ß√£o (JWT + API keys) operacional
- ‚úÖ Sistema de cr√©ditos calculando corretamente
- ‚úÖ Dashboard com dados reais
- ‚úÖ Integra√ß√£o Stripe mantida

### **N√£o-Funcionais:**
- ‚úÖ Performance igual ou superior ao Supabase
- ‚úÖ Zero perda de dados
- ‚úÖ Uptime > 99.9% p√≥s-migra√ß√£o  
- ‚úÖ Backups autom√°ticos funcionando

### **Operacionais:**
- ‚úÖ Documenta√ß√£o atualizada
- ‚úÖ Scripts de backup/restore testados
- ‚úÖ Monitoramento e alertas configurados
- ‚úÖ Rollback plan validado

---

## üéØ Pr√≥ximos Passos Imediatos

### **1. Criar bd.sql (Prioridade M√ÅXIMA)**
- Arquivo principal com toda estrutura MariaDB
- Includes: tabelas, √≠ndices, triggers, views, dados iniciais

### **2. Configurar Ambiente Local**
- MariaDB via Docker ou instala√ß√£o nativa
- Teste inicial do schema criado

### **3. Adaptar connection.py**
- Primeira integra√ß√£o Python ‚Üî MariaDB
- Teste b√°sico de conectividade

---

## üìû Suporte e Recursos

### **Documenta√ß√£o de Refer√™ncia:**
- [MariaDB Documentation](https://mariadb.com/kb/en/)
- [PyMySQL Documentation](https://pymysql.readthedocs.io/)
- [MySQL Connector/Python](https://dev.mysql.com/doc/connector-python/en/)

### **Ferramentas √öteis:**
- **DBeaver**: Interface gr√°fica para ambos os BDs
- **MySQL Workbench**: Design e migra√ß√£o
- **Adminer**: Interface web leve

---

## üèÅ Conclus√£o

Esta migra√ß√£o √© **tecnicamente vi√°vel** mas **complexa** devido ao volume de funcionalidades espec√≠ficas do PostgreSQL/Supabase que precisam ser adaptadas para MariaDB.

O maior desafio ser√° manter a **paridade funcional** especialmente no sistema de cr√©ditos (triggers complexos) e nas consultas anal√≠ticas do dashboard.

Com planejamento adequado e testes rigorosos, a migra√ß√£o pode ser realizada com **sucesso** e at√© mesmo resultar em **melhor performance** devido ao controle total sobre a infraestrutura de banco de dados.

---
**Documento criado em**: 22/09/2025  
**Vers√£o**: 1.0  
**Status**: Plano Inicial - Pronto para Implementa√ß√£o  
**Pr√≥xima etapa**: Cria√ß√£o do arquivo `bd.sql` üöÄ
