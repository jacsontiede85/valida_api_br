# üìä Estrutura Completa do Banco de Dados - Valida SaaS

## üéØ Vis√£o Geral

**Banco de Dados**: Supabase PostgreSQL  
**URL**: `https://gbmlcmpclrivmyyfcdvi.supabase.co`  
**Total de Tabelas**: 10 tabelas ativas  
**Sistema**: SaaS de Consultas CNPJ com Sistema de Cr√©ditos  
**√öltima An√°lise**: 18/09/2025 09:14:30

---

## üìã Resumo das Tabelas

| Tabela | Registros | Prop√≥sito | Status |
|--------|-----------|-----------|--------|
| `users` | 7 | Gest√£o de usu√°rios do sistema | ‚úÖ Ativo |
| `user_credits` | 2 | Sistema de cr√©ditos por usu√°rio | ‚úÖ Ativo |
| `subscription_plans` | 3 | Planos de assinatura dispon√≠veis | ‚úÖ Ativo |
| `subscriptions` | 2 | Assinaturas ativas dos usu√°rios | ‚úÖ Ativo |
| `api_keys` | 10 | Chaves de API dos usu√°rios | ‚úÖ Ativo |
| `consultation_types` | 6 | Tipos de consulta com custos | ‚úÖ Ativo |
| `consultations` | 1 | Hist√≥rico de consultas realizadas | ‚úÖ Ativo |
| `consultation_details` | 1 | Detalhes por tipo de cada consulta | ‚úÖ Ativo |
| `credit_transactions` | 2 | Transa√ß√µes de cr√©dito | ‚úÖ Ativo |
| `daily_analytics` | 1 | Analytics di√°rio consolidado | ‚úÖ Ativo |

---

## üèóÔ∏è Esquemas Detalhados das Tabelas

### 1. üë§ **users** - Gest√£o de Usu√°rios

**Prop√≥sito**: Tabela principal de usu√°rios do sistema SaaS

```sql
CREATE TABLE users (
    id UUID PRIMARY KEY,                    -- Identificador √∫nico
    email VARCHAR(255) UNIQUE NOT NULL,     -- Email de login
    name VARCHAR(255) NOT NULL,             -- Nome completo
    password_hash VARCHAR(255),             -- Hash da senha
    last_login TIMESTAMP,                   -- √öltimo login
    is_active BOOLEAN DEFAULT TRUE,         -- Status ativo
    created_at TIMESTAMP DEFAULT NOW(),     -- Data de cria√ß√£o
    updated_at TIMESTAMP DEFAULT NOW()      -- √öltima atualiza√ß√£o
);
```

**Dados de Exemplo**:
- 7 usu√°rios cadastrados
- Usu√°rio dev: `dev@valida.com.br`
- √öltimo login: 17/09/2025 16:16:56

**Relacionamentos**: 
- `user_credits.user_id` ‚Üí `users.id`
- `api_keys.user_id` ‚Üí `users.id`
- `subscriptions.user_id` ‚Üí `users.id`

---

### 2. üí∞ **user_credits** - Sistema de Cr√©ditos

**Prop√≥sito**: Controle de cr√©ditos por usu√°rio com renova√ß√£o autom√°tica

```sql
CREATE TABLE user_credits (
    id UUID PRIMARY KEY,                    -- ID √∫nico do registro
    user_id UUID REFERENCES users(id),     -- Refer√™ncia ao usu√°rio
    available_credits_cents INTEGER,       -- Cr√©ditos dispon√≠veis (centavos)
    total_purchased_cents INTEGER,         -- Total de cr√©ditos comprados
    total_used_cents INTEGER,              -- Total de cr√©ditos usados
    last_auto_renewal TIMESTAMP,           -- √öltima renova√ß√£o autom√°tica
    auto_renewal_count INTEGER DEFAULT 0,  -- Contador de renova√ß√µes
    created_at TIMESTAMP DEFAULT NOW(),    -- Data de cria√ß√£o
    updated_at TIMESTAMP DEFAULT NOW()     -- √öltima atualiza√ß√£o
);
```

**Sistema de Valores**:
- **Cr√©ditos iniciais**: R$ 10,00 (1000 centavos)
- **Renova√ß√£o autom√°tica**: Habilitada por padr√£o
- **Controle preciso**: Valores em centavos para evitar problemas de arredondamento

**Dados Atuais**:
- 2 usu√°rios com cr√©ditos configurados
- Saldo padr√£o: R$ 10,00 (1000 centavos)

---

### 3. üì¶ **subscription_plans** - Planos de Assinatura

**Prop√≥sito**: Cat√°logo de planos dispon√≠veis no SaaS

```sql
CREATE TABLE subscription_plans (
    id UUID PRIMARY KEY,                    -- ID √∫nico do plano
    code VARCHAR(50) UNIQUE,               -- C√≥digo do plano (basic, pro, enterprise)
    name VARCHAR(100) NOT NULL,            -- Nome do plano
    description TEXT,                      -- Descri√ß√£o detalhada
    price_cents INTEGER NOT NULL,         -- Pre√ßo em centavos
    credits_included_cents INTEGER,       -- Cr√©ditos inclusos
    api_keys_limit INTEGER DEFAULT 1,     -- Limite de chaves API
    auto_renew_on_depletion BOOLEAN,      -- Renova√ß√£o autom√°tica
    is_active BOOLEAN DEFAULT TRUE,       -- Plano ativo
    created_at TIMESTAMP DEFAULT NOW(),   -- Data de cria√ß√£o
    updated_at TIMESTAMP DEFAULT NOW()    -- √öltima atualiza√ß√£o
);
```

**Planos Dispon√≠veis**:

| C√≥digo | Nome | Pre√ßo | Cr√©ditos | API Keys | Renova√ß√£o |
|--------|------|-------|----------|----------|-----------|
| `basic` | Plano B√°sico | R$ 100,00 | R$ 100,00 | 1 | ‚úÖ |
| `professional` | Plano Profissional | R$ 300,00 | R$ 300,00 | 5 | ‚úÖ |
| `enterprise` | Plano Empresarial | R$ 500,00 | R$ 500,00 | 10 | ‚úÖ |

---

### 4. üîê **api_keys** - Chaves de API

**Prop√≥sito**: Gerenciamento de chaves de API por usu√°rio

```sql
CREATE TABLE api_keys (
    id UUID PRIMARY KEY,                    -- ID √∫nico da chave
    user_id UUID REFERENCES users(id),     -- Propriet√°rio da chave
    key_hash VARCHAR(255) NOT NULL,        -- Hash da chave (seguran√ßa)
    name VARCHAR(100) NOT NULL,            -- Nome da chave
    is_active BOOLEAN DEFAULT TRUE,        -- Status ativo
    last_used_at TIMESTAMP,               -- √öltimo uso
    daily_queries INTEGER DEFAULT 0,       -- Queries do dia atual
    daily_cost_cents INTEGER DEFAULT 0,    -- Custo di√°rio
    created_at TIMESTAMP DEFAULT NOW(),    -- Data de cria√ß√£o
    updated_at TIMESTAMP DEFAULT NOW()     -- √öltima atualiza√ß√£o
);
```

**Dados Atuais**:
- 10 chaves API cadastradas
- Sistema de hash para seguran√ßa
- Controle de uso di√°rio por chave

---

### 5. üè∑Ô∏è **consultation_types** - Tipos de Consulta

**Prop√≥sito**: Cat√°logo de tipos de consulta dispon√≠veis com seus custos

```sql
CREATE TABLE consultation_types (
    id UUID PRIMARY KEY,                    -- ID √∫nico do tipo
    code VARCHAR(50) UNIQUE NOT NULL,      -- C√≥digo do tipo
    name VARCHAR(100) NOT NULL,            -- Nome do tipo
    description TEXT,                      -- Descri√ß√£o
    cost_cents INTEGER NOT NULL,          -- Custo em centavos
    provider VARCHAR(50) NOT NULL,        -- Provedor (resolve_cenprot, cnpja)
    is_active BOOLEAN DEFAULT TRUE,       -- Tipo ativo
    created_at TIMESTAMP DEFAULT NOW(),   -- Data de cria√ß√£o
    updated_at TIMESTAMP DEFAULT NOW()    -- √öltima atualiza√ß√£o
);
```

**Tipos Dispon√≠veis**:

| C√≥digo | Nome | Custo | Provedor | Descri√ß√£o |
|--------|------|-------|----------|-----------|
| `protestos` | Consulta de Protestos | R$ 0,15 | resolve_cenprot | Consulta protestos via Resolve CenProt |
| `receita_federal` | Receita Federal | R$ 0,05 | cnpja | Dados b√°sicos da empresa |
| `simples_nacional` | Simples Nacional | R$ 0,05 | cnpja | Regime tribut√°rio |
| `cadastro_contribuintes` | Cadastro de Contribuintes | R$ 0,05 | cnpja | Inscri√ß√µes estaduais |
| `geocodificacao` | Geocodifica√ß√£o | R$ 0,05 | cnpja | Coordenadas geogr√°ficas |
| `suframa` | Suframa | R$ 0,05 | cnpja | Dados da Suframa |

---

### 6. üìã **consultations** - Hist√≥rico de Consultas

**Prop√≥sito**: Registro principal de todas as consultas realizadas

```sql
CREATE TABLE consultations (
    id UUID PRIMARY KEY,                    -- ID √∫nico da consulta
    user_id UUID REFERENCES users(id),     -- Usu√°rio que fez a consulta
    api_key_id UUID REFERENCES api_keys(id), -- Chave API utilizada
    cnpj VARCHAR(18) NOT NULL,             -- CNPJ consultado
    status VARCHAR(20) DEFAULT 'success',  -- Status (success, error, partial)
    total_cost_cents INTEGER DEFAULT 0,   -- Custo total da consulta
    response_time_ms INTEGER,             -- Tempo de resposta
    cache_used BOOLEAN DEFAULT FALSE,     -- Se usou cache
    error_message TEXT,                   -- Mensagem de erro (se houver)
    created_at TIMESTAMP DEFAULT NOW()    -- Data da consulta
);
```

**M√©tricas**:
- 1 consulta registrada no sistema
- Controle de performance (response_time_ms)
- Sistema de cache implementado

---

### 7. üìä **consultation_details** - Detalhes por Tipo

**Prop√≥sito**: Detalhamento de cada tipo de consulta realizada

```sql
CREATE TABLE consultation_details (
    id UUID PRIMARY KEY,                             -- ID √∫nico do detalhe
    consultation_id UUID REFERENCES consultations(id), -- Consulta pai
    consultation_type_id UUID REFERENCES consultation_types(id), -- Tipo consultado
    success BOOLEAN NOT NULL DEFAULT TRUE,          -- Sucesso do tipo espec√≠fico
    cost_cents INTEGER NOT NULL,                    -- Custo espec√≠fico
    response_data JSONB,                           -- Dados retornados
    cache_used BOOLEAN DEFAULT FALSE,              -- Cache usado neste tipo
    response_time_ms INTEGER,                      -- Tempo espec√≠fico
    error_message TEXT,                            -- Erro espec√≠fico
    created_at TIMESTAMP DEFAULT NOW()             -- Data do detalhe
);
```

**Funcionalidade**:
- Permite consultas multi-tipo (ex: Protestos + Receita Federal)
- Controle granular de custos por tipo
- Dados JSONB para flexibilidade de resposta

---

### 8. üí≥ **credit_transactions** - Transa√ß√µes de Cr√©dito

**Prop√≥sito**: Hist√≥rico completo de todas as transa√ß√µes de cr√©dito

```sql
CREATE TABLE credit_transactions (
    id UUID PRIMARY KEY,                    -- ID √∫nico da transa√ß√£o
    user_id UUID REFERENCES users(id),     -- Usu√°rio da transa√ß√£o
    transaction_type VARCHAR(50),          -- Tipo (purchase, usage, refund, renewal)
    amount_cents INTEGER NOT NULL,        -- Valor da transa√ß√£o
    description TEXT,                     -- Descri√ß√£o da transa√ß√£o
    consultation_id UUID,                 -- Consulta relacionada (se aplic√°vel)
    balance_after_cents INTEGER,         -- Saldo ap√≥s transa√ß√£o
    created_at TIMESTAMP DEFAULT NOW(),   -- Data da transa√ß√£o
    metadata JSONB                        -- Dados adicionais
);
```

**Tipos de Transa√ß√£o**:
- `purchase` - Compra de cr√©ditos
- `usage` - Uso em consultas
- `refund` - Estorno
- `renewal` - Renova√ß√£o autom√°tica

---

### 9. üìà **daily_analytics** - Analytics Di√°rio

**Prop√≥sito**: M√©tricas consolidadas por dia para relat√≥rios

```sql
CREATE TABLE daily_analytics (
    id UUID PRIMARY KEY,                    -- ID √∫nico do registro
    user_id UUID REFERENCES users(id),     -- Usu√°rio das m√©tricas
    date DATE NOT NULL,                    -- Data das m√©tricas
    total_consultations INTEGER DEFAULT 0, -- Total de consultas
    successful_consultations INTEGER DEFAULT 0, -- Consultas bem-sucedidas
    failed_consultations INTEGER DEFAULT 0, -- Consultas com falha
    total_cost_cents INTEGER DEFAULT 0,   -- Custo total do dia
    protestos_count INTEGER DEFAULT 0,    -- Quantidade de consultas de protestos
    receita_count INTEGER DEFAULT 0,      -- Quantidade de consultas da receita
    avg_response_time_ms INTEGER,         -- Tempo m√©dio de resposta
    cache_hit_rate DECIMAL(5,2),         -- Taxa de cache hits
    created_at TIMESTAMP DEFAULT NOW(),   -- Data de cria√ß√£o
    updated_at TIMESTAMP DEFAULT NOW()    -- √öltima atualiza√ß√£o
);
```

**M√©tricas Dispon√≠veis**:
- Performance: tempo de resposta, taxa de cache
- Uso: consultas por tipo, custos
- Qualidade: taxa de sucesso/falha

---

### 10. üè¢ **subscriptions** - Assinaturas Ativas

**Prop√≥sito**: Controle das assinaturas ativas dos usu√°rios

```sql
CREATE TABLE subscriptions (
    id UUID PRIMARY KEY,                    -- ID √∫nico da assinatura
    user_id UUID REFERENCES users(id),     -- Usu√°rio da assinatura
    plan_id UUID REFERENCES subscription_plans(id), -- Plano assinado
    status VARCHAR(20) DEFAULT 'active',   -- Status da assinatura
    stripe_subscription_id VARCHAR(255),   -- ID no Stripe
    current_period_start TIMESTAMP,       -- In√≠cio do per√≠odo atual
    current_period_end TIMESTAMP,         -- Fim do per√≠odo atual
    auto_renew BOOLEAN DEFAULT TRUE,       -- Renova√ß√£o autom√°tica
    created_at TIMESTAMP DEFAULT NOW(),   -- Data de cria√ß√£o
    updated_at TIMESTAMP DEFAULT NOW()    -- √öltima atualiza√ß√£o
);
```

**Integra√ß√£o**:
- Conectado ao Stripe para pagamentos
- Controle de per√≠odos de cobran√ßa
- Sistema de renova√ß√£o autom√°tica

---

## üîó Relacionamentos Entre Tabelas

```mermaid
graph TD
    A[users] --> B[user_credits]
    A --> C[api_keys]
    A --> D[subscriptions]
    A --> E[consultations]
    A --> F[credit_transactions]
    A --> G[daily_analytics]
    
    H[subscription_plans] --> D
    I[consultation_types] --> J[consultation_details]
    C --> E
    E --> J
    E --> F
```

### üéØ Relacionamentos Cr√≠ticos:

1. **users** √© o centro do sistema - todas as outras tabelas referenciam usu√°rios
2. **consultations** ‚Üí **consultation_details** (1:N) - Uma consulta pode ter m√∫ltiplos tipos
3. **consultation_types** define custos ‚Üí usado em **consultation_details**
4. **credit_transactions** registra cada movimenta√ß√£o de cr√©dito
5. **daily_analytics** agrega dados para relat√≥rios de performance

---

## üí° Padr√µes e Conven√ß√µes

### üè∑Ô∏è **Nomenclatura**:
- `id` - Sempre UUID como chave prim√°ria
- `user_id` - Refer√™ncia para usu√°rios
- `*_at` - Campos de timestamp
- `*_cents` - Valores monet√°rios em centavos
- `is_*` - Campos boolean

### üí∞ **Sistema de Cr√©ditos**:
- **Todos os valores em centavos** para precis√£o
- **R$ 1,00 = 100 centavos**
- **Protestos**: 15 centavos (R$ 0,15)
- **Outros tipos**: 5 centavos (R$ 0,05)

### üîÑ **Sistema de Renova√ß√£o**:
- Renova√ß√£o autom√°tica quando cr√©ditos < custo da consulta
- Hist√≥rico completo em `credit_transactions`
- Contadores em `user_credits.auto_renewal_count`

---

## üìä Status Atual do Banco

### ‚úÖ **Dados Existentes**:
- **7 usu√°rios** cadastrados
- **3 planos** de assinatura ativos
- **10 chaves API** criadas
- **6 tipos de consulta** configurados
- **Sistema de cr√©ditos** funcionando
- **Analytics** implementado

### üéØ **Funcionalidades Ativas**:
- ‚úÖ Cadastro e autentica√ß√£o de usu√°rios
- ‚úÖ Sistema de cr√©ditos com renova√ß√£o autom√°tica
- ‚úÖ M√∫ltiplos tipos de consulta com custos espec√≠ficos
- ‚úÖ Controle de API keys por usu√°rio
- ‚úÖ Hist√≥rico detalhado de consultas
- ‚úÖ Analytics consolidado
- ‚úÖ Integra√ß√£o com Stripe preparada

### üîß **Para Desenvolvimento de IA**:
- **Estrutura est√°vel** e bem documentada
- **Dados reais** dispon√≠veis para testes
- **APIs funcionais** para todos os servi√ßos
- **Sistema de cr√©ditos** transparente e preciso
- **Relacionamentos claros** entre entidades

---

## üöÄ Pr√≥ximos Passos para IA

1. **Usar esta documenta√ß√£o** como refer√™ncia para queries
2. **Conectar servi√ßos** aos endpoints do run.py
3. **Testar consultas** usando dados reais
4. **Implementar dashboards** com m√©tricas reais
5. **Validar sistema de cr√©ditos** em funcionamento

---

**üìã Status**: Banco de dados COMPLETO e FUNCIONAL  
**üìÖ √öltima Atualiza√ß√£o**: 18/09/2025  
**üîó Conex√£o**: Supabase PostgreSQL  
**‚úÖ Pronto para**: Integra√ß√£o com frontend e APIs
