<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Valida - Vis√£o Geral</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap"
        rel="stylesheet" />
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            color: #E5E7EB;
        }

        .sidebar {
            background-color: #1F2937;
        }

        .header {
            background-color: #1F2937;
            border-bottom: 1px solid #374151;
        }

        .card {
            background-color: #1F2937;
            border-radius: 0.5rem;
        }

        .btn-primary {
            background-color: #3B82F6;
            color: white;
        }

        .btn-secondary {
            background-color: #374151;
            color: #D1D5DB;
        }

        .active-link {
            background-color: #374151;
            color: white;
            border-radius: 0.375rem;
        }

        .inactive-link {
            color: #9CA3AF;
        }
    </style>
</head>

<body class="flex h-screen">
    <aside class="sidebar w-64 p-4 flex flex-col justify-between">
        <div>
            <div class="flex items-center mb-8">
                <img alt="Valida Logo" class="h-8 mr-2"
                    src="https://lh3.googleusercontent.com/aida-public/AB6AXuCPiTytodUSa_qp8ErIXjl0HYcDeCG9qNnFRFMu2Cz3a70lhzaWNupQM787LTBKoya6Hwg62W3qRnPmvQQzXeAQaXuWZfXcb4SrOdfms8pIuqpb7uzakD8yVUxkrr3LuKCN9QMPc_uN5RLSQORm2FFOEGk0_wxLiUFXS6w-BH5OHDr1upOSICkK0moQtHR9wUmj7FaVGYQdnp6mCZYd_L9_vpWQgHr7dMsEkV7IFNCExMBYr8IQYoZJ4n1duMfJvd0II_MlpFC78m8" />
                <span class="text-xl font-bold">Valida</span>
            </div>
            <nav class="space-y-2">
                <div class="text-xs text-gray-500 uppercase font-bold mb-2">Geral</div>
                <a class="flex items-center p-2 active-link" href="#">
                    <span class="material-icons mr-3">dashboard</span> Vis√£o Geral
                </a>
                <a class="flex items-center p-2 inactive-link hover:bg-gray-700 rounded-md" href="/consultas">
                    <span class="material-icons mr-3">search</span> Consultas
                </a>
                <div class="pt-4 text-xs text-gray-500 uppercase font-bold mb-2">Integra√ß√µes</div>
                <a class="flex items-center p-2 inactive-link hover:bg-gray-700 rounded-md" href="/history">
                    <span class="material-icons mr-3">history</span> Hist√≥rico
                </a>
                <a class="flex items-center p-2 inactive-link hover:bg-gray-700 rounded-md" href="/api-keys">
                    <span class="material-icons mr-3">key</span> Chave de API
                </a>
                <div class="pt-4 text-xs text-gray-500 uppercase font-bold mb-2">Administra√ß√£o</div>
                <a class="flex items-center p-2 inactive-link hover:bg-gray-700 rounded-md" href="/assinatura">
                    <span class="material-icons mr-3">subscriptions</span> Assinaturas
                </a>
                <a class="flex items-center p-2 inactive-link hover:bg-gray-700 rounded-md" href="/faturas">
                    <span class="material-icons mr-3">receipt_long</span> Faturamento
                </a>
                <a class="flex items-center p-2 inactive-link hover:bg-gray-700 rounded-md" href="/perfil">
                    <span class="material-icons mr-3">person</span> Perfil
                </a>
            </nav>
        </div>
    </aside>
    <div class="flex-1 flex flex-col">
        <!-- <header class="header h-16 flex items-center justify-between px-6">
            <div class="flex items-center">
                <a class="font-semibold mr-4" href="#">Consultas <span
                        class="material-icons text-sm align-middle">expand_more</span></a>
                <a class="font-semibold mr-4" href="#">API <span
                        class="material-icons text-sm align-middle">expand_more</span></a>
                <a class="font-semibold" href="#">Planos</a>
            </div>
            <div class="flex items-center space-x-4">
                <div class="relative">
                    <span class="material-icons absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">search</span>
                    <input
                        class="bg-gray-800 border border-gray-600 rounded-md py-2 pl-10 pr-4 w-64 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="Pesquisar" type="text" />
                    <span
                        class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 text-xs font-mono">CTRL+K</span>
                </div>
                <div class="flex items-center space-x-2 bg-blue-500/20 text-blue-400 px-3 py-1 rounded-md">
                    <span data-stat="creditos-header">R$ 0,00</span>
                    <span class="material-icons text-sm">toll</span>
                </div>
            </div>
        </header> -->
        <main class="flex-1 p-6 overflow-y-auto">
            <!-- üé® Loader discreto otimizado - UX v2.2 -->
            <div id="dashboard-loader" class="fixed top-4 right-4 z-50 bg-gray-800/95 backdrop-blur-sm rounded-lg p-3 shadow-xl border border-gray-700/50 hidden transition-all duration-300 ease-out opacity-0 transform translate-y-2 scale-95">
                <div class="flex items-center space-x-3">
                    <div class="relative">
                        <div class="animate-spin rounded-full h-4 w-4 border-2 border-blue-500/30 border-t-blue-500"></div>
                        <div class="absolute inset-0 animate-pulse rounded-full h-4 w-4 border border-blue-400/20"></div>
                    </div>
                    <span class="text-sm text-gray-200 font-medium tracking-wide">Atualizando dados...</span>
                </div>
                <!-- Mini barra de progresso sutil -->
                <div class="mt-2 h-0.5 bg-gray-700 rounded-full overflow-hidden">
                    <div class="h-full bg-gradient-to-r from-blue-500 to-blue-400 animate-pulse rounded-full"></div>
                </div>
            </div>

            <div class="flex justify-between items-center mb-6">
                <h1 class="text-2xl font-bold">Vis√£o Geral</h1>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center bg-gray-800 rounded-md">
                        <button class="px-3 py-2 text-sm font-medium text-gray-400 hover:bg-gray-700 rounded-l-md"
                            data-period="today">Hoje</button>
                        <button class="px-3 py-2 text-sm font-medium text-white bg-gray-900"
                            data-period="30d">30d</button>
                        <button class="px-3 py-2 text-sm font-medium text-gray-400 hover:bg-gray-700"
                            data-period="90d">90d</button>
                        <button class="px-3 py-2 text-sm font-medium text-gray-400 hover:bg-gray-700"
                            data-period="120d">120d</button>
                        <button class="px-3 py-2 text-sm font-medium text-gray-400 hover:bg-gray-700"
                            data-period="180d">180d</button>
                        <button class="px-3 py-2 text-sm font-medium text-gray-400 hover:bg-gray-700 rounded-r-md"
                            data-period="365d">365d</button>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                <div class="card p-4 transition-all duration-200 hover:bg-gray-800/50 hover:scale-105 hover:shadow-xl">
                    <h3 class="text-sm font-medium text-gray-400">Cr√©ditos Dispon√≠veis</h3>
                    <p class="text-3xl font-bold mt-2 text-green-400 transition-all duration-300" data-stat="creditos-disponiveis">R$ 0,00</p>
                    <div class="flex justify-between text-xs text-gray-500 mt-1">
                        <span>Comprados: <span data-stat="creditos-comprados" class="text-blue-400">R$
                                0,00</span></span>
                        <span>Usados: <span data-stat="creditos-usados" class="text-red-400">R$ 0,00</span></span>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Renova√ß√£o autom√°tica: <span data-auto-renewal-status
                            class="text-green-400">Ativa</span></p>
                </div>
                <div class="card p-4 transition-all duration-200 hover:bg-gray-800/50 hover:scale-105 hover:shadow-xl">
                    <h3 class="text-sm font-medium text-gray-400">Consumo no Per√≠odo</h3>
                    <p class="text-3xl font-bold mt-2 text-orange-400 transition-all duration-300" data-stat="consumo-periodo-total">R$ 0,00</p>
                    <div class="text-xs text-gray-500 mt-1">
                        <div class="flex justify-between mb-1">
                            <span>Protestos:</span>
                            <span data-stat="protestos_cost" class="text-yellow-400">R$ 0,00</span>
                        </div>
                        <div class="flex justify-between mb-1">
                            <span>Receita Federal:</span>
                            <span data-stat="receita_federal_cost" class="text-green-400">R$ 0,00</span>
                        </div>
                        <div class="flex justify-between mb-1">
                            <span>Simples Nacional:</span>
                            <span data-stat="simples_nacional_cost" class="text-orange-400">R$ 0,00</span>
                        </div>
                        <div class="flex justify-between mb-1">
                            <span>Cadastro Contrib.:</span>
                            <span data-stat="cadastro_contribuintes_cost" class="text-purple-400">R$ 0,00</span>
                        </div>
                        <div class="flex justify-between mb-1">
                            <span>Geocodifica√ß√£o:</span>
                            <span data-stat="geocodificacao_cost" class="text-blue-400">R$ 0,00</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Suframa:</span>
                            <span data-stat="suframa_cost" class="text-pink-400">R$ 0,00</span>
                        </div>
                    </div>
                </div>
                <div class="card p-4 transition-all duration-200 hover:bg-gray-800/50 hover:scale-105 hover:shadow-xl">
                    <h3 class="text-sm font-medium text-gray-400">Consultas Realizadas</h3>
                    <p class="text-3xl font-bold mt-2 text-blue-400 transition-all duration-300" data-stat="total_consultations">0</p>
                    <div class="text-xs text-gray-500 mt-1">
                        <div class="flex justify-between mb-1">
                            <span>Protestos:</span>
                            <span data-stat="protestos_count" class="text-yellow-400">0</span>
                        </div>
                        <div class="flex justify-between mb-1">
                            <span>Receita Federal:</span>
                            <span data-stat="receita_federal_count" class="text-green-400">0</span>
                        </div>
                        <div class="flex justify-between mb-1">
                            <span>Simples Nacional:</span>
                            <span data-stat="simples_nacional_count" class="text-orange-400">0</span>
                        </div>
                        <div class="flex justify-between mb-1">
                            <span>Cadastro Contrib.:</span>
                            <span data-stat="cadastro_contribuintes_count" class="text-purple-400">0</span>
                        </div>
                        <div class="flex justify-between mb-1">
                            <span>Geocodifica√ß√£o:</span>
                            <span data-stat="geocodificacao_count" class="text-blue-400">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Suframa:</span>
                            <span data-stat="suframa_count" class="text-pink-400">0</span>
                        </div>
                    </div>
                </div>
                <div class="card p-4 transition-all duration-200 hover:bg-gray-800/50 hover:scale-105 hover:shadow-xl">
                    <h3 class="text-sm font-medium text-gray-400">Custo Total</h3>
                    <p class="text-3xl font-bold mt-2 text-purple-400 transition-all duration-300" data-stat="total_cost">R$ 0,00</p>
                    <div class="text-xs text-gray-500 mt-1">
                        <div class="mb-1">Custo m√©dio: <span data-stat="custo-medio" class="text-white">R$ 0,00</span>
                        </div>
                        <div class="text-xs text-gray-600" data-cost-summary>Carregando custos...</div>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                <div class="lg:col-span-3 card p-6 flex flex-col transition-all duration-200 hover:bg-gray-800/30">
                    <h2 class="text-lg font-semibold mb-4">Consumo de Cr√©ditos por Per√≠odo</h2>
                    <div class="relative flex-1 min-h-0">
                        <!-- üìä Canvas com transi√ß√£o suave UX v2.2 -->
                        <canvas id="apiConsumptionChart" class="transition-opacity duration-300"></canvas>
                    </div>
                </div>
                <div class="lg:col-span-2 card p-6 transition-all duration-200 hover:bg-gray-800/30">
                    <h2 class="text-lg font-semibold mb-2">Distribui√ß√£o por Tipo de Servi√ßo</h2>
                    <p class="text-xs text-gray-400 mb-4">Mostra quantas vezes cada servi√ßo foi utilizado (consultas
                        podem combinar m√∫ltiplos tipos)</p>
                    <div class="relative h-70">
                        <!-- üìä Canvas com transi√ß√£o suave UX v2.2 -->
                        <canvas id="apiVolumeChart" class="transition-opacity duration-300"></canvas>
                    </div>

                    <!-- Estat√≠sticas resumidas do gr√°fico -->
                    <div class="mt-4 p-3 bg-gray-800/50 rounded-lg border border-gray-600/50">
                        <div class="flex items-center justify-between text-sm">
                            <div class="flex items-center gap-2">
                                <span class="material-icons text-blue-400 text-sm">analytics</span>
                                <span class="text-gray-300">Estat√≠sticas de Uso</span>
                            </div>
                            <span id="total-usos-tipos" class="text-white font-medium">- usos totais</span>
                        </div>
                        <div class="mt-2 text-xs text-gray-400" id="uso-medio-info">
                            M√©dia de tipos por consulta: <span class="text-white font-medium" id="media-tipos">-</span>
                        </div>
                    </div>

                </div>
            </div>
        </main>
    </div>

    <!-- Scripts carregados no final para garantir que o DOM esteja pronto -->
    <script src="/static/js/cost_loader.js"></script>
    <script src="/static/js/dashboard_real.js"></script>

    <!-- üéØ Script de inicializa√ß√£o otimizada UX v2.2 -->
    <script>
        console.log('üé® Dashboard UX v2.2 - Scripts carregados com otimiza√ß√µes visuais');

        // Fun√ß√£o para criar token de desenvolvimento se necess√°rio
        async function ensureDevToken() {
            const token = localStorage.getItem('auth_token') || localStorage.getItem('session_token');

            if (!token) {
                console.log('‚ö†Ô∏è Sem token, criando token de desenvolvimento...');
                try {
                    const response = await fetch('/api/v1/auth/dev-token', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        localStorage.setItem('auth_token', data.token);
                        console.log('‚úÖ Token de desenvolvimento criado:', data.user_id);
                        return data.token;
                    }
                } catch (error) {
                    console.error('‚ùå Erro ao criar token de desenvolvimento:', error);
                }
            }
            return token;
        }

        // Fun√ß√£o para testar o loader discreto (DEBUG)
        window.testLoader = function() {
            const loader = document.getElementById('dashboard-loader');
            if (loader) {
                console.log('üîÑ Testando loader discreto...');
                // Simular loading por 3 segundos
                loader.classList.remove('hidden');
                requestAnimationFrame(() => {
                    loader.classList.remove('opacity-0', 'translate-y-2');
                    loader.classList.add('opacity-100', 'translate-y-0');
                });
                
                setTimeout(() => {
                    loader.classList.remove('opacity-100', 'translate-y-0');
                    loader.classList.add('opacity-0', 'translate-y-2');
                    setTimeout(() => loader.classList.add('hidden'), 300);
                }, 3000);
                
                console.log('‚úÖ Teste do loader conclu√≠do (3s)');
            } else {
                console.error('‚ùå Loader n√£o encontrado');
            }
        };

        // Inicializar com verifica√ß√µes
        (async () => {
            // Garantir que temos um token
            const token = await ensureDevToken();
            console.log('üîê Token dispon√≠vel?', !!token);

            // Verificar Chart.js
            console.log('üìä Chart.js carregado?', typeof Chart !== 'undefined');

            // Aguardar um pouco e verificar o dashboard
            setTimeout(() => {
                console.log('üéØ Dashboard inicializado?', !!window.realDashboard);

                if (!window.realDashboard && typeof Chart !== 'undefined') {
                    console.log('üîÑ Inicializando dashboard manualmente...');
                    window.realDashboard = new RealDashboard();
                }

                if (window.realDashboard) {
                    console.log('‚úÖ Dashboard UX v2.2 est√° rodando com otimiza√ß√µes visuais');
                    console.log('üß™ Para testar o loader, digite: testLoader()');
                    console.log('üé® Novo sistema: debouncing, smart charts, singleton pattern');
                    // For√ßar uma atualiza√ß√£o dos dados
                    window.realDashboard.loadRealDashboardData();
                } else {
                    console.error('‚ùå Dashboard n√£o p√¥de ser inicializado');
                }
            }, 1500);
        })();
    </script>

</body>

</html>